name: Bump project version

on:
    pull_request:
        branches:
            - master
        types:
            - opened
    workflow_dispatch:
        inputs:
            version:
                description: 'New Maven version'
                required: true

jobs:
    bump-version:
        if: github.event_name == 'workflow_dispatch' || github.actor == 'dependabot[bot]'
        runs-on: ubuntu-latest

        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # needed for git info plugins like git-commit-id-plugin

            - name: Set up Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: maven

            - name: Extract project version from POM
              id: get_version
              uses: dostonhamrakulov/maven-artifact-version-extractor@v1.0
              with:
                  file_path: ${{ github.workspace }}/pom.xml

            - name: Set new project version
              id: bump
              run: |
                  echo "Current version: ${{ steps.get_version.outputs.version }}"
                  NEW_VERSION=""
                  if [[ "${{ github.event.inputs.version }}" =~ ^[1-9][0-9]*\.(0|[1-9][0-9]*)(\.(0|[1-9][0-9]*))?$ ]]; then
                    NEW_VERSION="${{ github.event.inputs.version }}"
                  else
                    IFS='.' read -r major minor patch <<< "${{ steps.get_version.outputs.version }}"
                    if [ -z "$patch" ]; then
                      NEW_VERSION="${major}.$((minor + 1))"
                    else
                      NEW_VERSION="${major}.${minor}.$((patch + 1))"
                    fi
                  fi
                  echo "New version: $NEW_VERSION"
                  echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

            - name: Bump pom version
              run: |
                  mvn versions:set -DnewVersion=${{ steps.bump.outputs.new_version }}
                  mvn versions:commit

            - name: Commit and push updated version
              run: |
                  git config user.name "dependabot-version-bot"
                  git config user.email "actions@github.com"
                  git add pom.xml
                  git commit -m "Auto-bump project version to ${{ steps.bump.outputs.new_version }}"
                  git push

            - name: Enable auto-merge for Dependabot PR
              if: github.actor == 'dependabot[bot]'
              uses: reitermarkus/automerge@v2
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  merge-method: squash
                  squash-commit-title: "v${{ steps.bump.outputs.new_version }}"
                  squash-commit-message: ""
