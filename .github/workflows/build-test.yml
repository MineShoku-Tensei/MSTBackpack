name: Test

on:
    pull_request:
        branches:
            - master
        types:
            - opened
            - synchronize
            - reopened
            - ready_for_review
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build:
        if: github.event.pull_request.draft != true
        permissions:
            contents: read
            packages: read
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # needed for git info plugins like git-commit-id-plugin

            - name: Set up Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: maven

            - name: Maven settings for GitHub
              uses: s4u/maven-settings-action@v4.0.0
              env:
                  GITHUB_ACTOR: ${{ github.actor }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Check Maven settings
              run: |
                  cat ~/.m2/settings.xml
                  cat /home/runner/.m2/settings.xml

            - name: Build with Maven
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  cat .github/maven-settings.xml
                  mvn -B -s .github/maven-settings.xml clean package

            - name: Find JAR
              run: |
                  count=$(find . -maxdepth 1 -type f -name '*.jar' | wc -l)
                  if [ "$count" -ne 1 ]; then
                    echo "Error: expected 1 JAR file, found $count"
                    exit 1
                  fi
